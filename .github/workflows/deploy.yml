name: Deploy SAT Website via AWS SSM

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: true

jobs:
  check-author:
    name: Check Commit Author
    runs-on: ubuntu-latest
    outputs:
      is-owner: ${{ steps.check.outputs.is-owner }}
    steps:
      - name: Check if owner
        id: check
        run: |
          OWNER_USERNAME="PARESHRANJAN299"
          ACTOR="${{ github.actor }}"
          
          if [ "$ACTOR" == "$OWNER_USERNAME" ]; then
            echo "is-owner=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Owner detected: $ACTOR - Auto-deploy enabled"
          else
            echo "is-owner=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Non-owner detected: $ACTOR - Approval required"
          fi

  deploy:
    name: Production Deploy (SSM)
    runs-on: ubuntu-latest
    needs: check-author
    environment:
      name: ${{ needs.check-author.outputs.is-owner == 'true' && 'production-auto' || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Deploy via SSM
        run: |
          echo "üöÄ Starting deployment..."
          echo "Deployer: ${{ github.actor }}"
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy SAT Website from GitHub Actions" \
            --parameters 'commands=[
              "#!/bin/bash",
              "set -e",
              "echo \"Running as: $(whoami)\"",
              "sudo -u deploy bash << '\''DEPLOYEOF'\''",
              "set -e",
              "cd /var/www/sat/sat-website",
              "echo \"üì¶ Fetching latest code...\"",
              "git fetch origin main",
              "git reset --hard origin/main",
              "echo \"üêç Activating virtualenv...\"",
              "source venv/bin/activate",
              "echo \"üì¶ Installing dependencies...\"",
              "pip install --upgrade pip",
              "pip install -r requirements.txt",
              "echo \"‚úÖ Code updated successfully\"",
              "DEPLOYEOF",
              "echo \"üîÑ Reloading Gunicorn...\"",
              "sudo -u deploy sudo systemctl reload sat",
              "echo \"‚úÖ Deployment completed successfully\""
            ]' \
            --output text \
            --query "Command.CommandId")
          
          echo "Command ID: $COMMAND_ID"
          echo "Waiting for command to complete..."
          
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}"
          
          echo "‚úÖ SSM command executed successfully"
          
          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --output text \
            --query "StandardOutputContent")
          
          echo "üìã Deployment output:"
          echo "$OUTPUT"
```

### **Step 3: Commit the Changes**

- Commit message: `fix: deploy workflow uses deploy user with proper permissions`
- Click **"Commit changes"** (green button)
- Select: **"Commit directly to the main branch"**

---

## üìä WHAT WILL HAPPEN

Once you commit:

1. ‚ö° GitHub Actions triggers automatically
2. ‚úÖ Check Commit Author (detects you as owner)
3. ‚úÖ Production Deploy (SSM) runs without approval
4. üöÄ Deployment executes:
   - Switches to `deploy` user
   - Fetches latest code from GitHub
   - Updates dependencies
   - Reloads Gunicorn
5. ‚úÖ Website updates at https://www.sat.net.in/

---

## üëÄ WATCH IT HAPPEN

After committing:

1. Go to: **Actions** tab (top menu)
2. You'll see: "fix: deploy workflow uses deploy user..."
3. Click on it
4. Watch both jobs complete with ‚úÖ

---

## üéØ EXPECTED OUTPUT

You should see:
```
‚úÖ Check Commit Author
‚úÖ Production Deploy (SSM)
   Running as: ssm-user
   üì¶ Fetching latest code...
   üêç Activating virtualenv...
   üì¶ Installing dependencies...
   ‚úÖ Code updated successfully
   üîÑ Reloading Gunicorn...
   ‚úÖ Deployment completed successfully
